<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Engagement Survey Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Dashboard specific styles moved to style.css -->
</head>
<body>
    <div class="dashboard-container">
        <header class="dashboard-header">
            <img src="{{ url_for('static', filename='logo.png') }}" alt="Company Logo" class="header-logo">
            <div class="header-text">
                <h1 class="header-title">Your Company Engagement Survey</h1>
                <p class="header-subtitle"><small>* Item data not shown if sample size is less than 4. Workgroup data not shown to protect confidentiality.</small></p>
            </div>
            <div class="header-controls">
                 <label for="yearSelector">Select Year:</label>
                 <select id="yearSelector" name="year">
                     <option value="">Loading...</option>
                 </select>
            </div>
        </header>

        <main class="dashboard-grid">
             <!-- Top Row -->
            <div class="dashboard-card engagement-index">
                <h3>ENGAGEMENT INDEX</h3>
                <div class="engagement-legend">
                    <span class="legend-item"><span class="legend-color legend-engaged"></span> Engaged</span>
                    <span class="legend-item"><span class="legend-color legend-not-engaged"></span> Not Engaged</span>
                    <span class="legend-item"><span class="legend-color legend-disengaged"></span> Actively Disengaged</span>
                </div>
                <div class="engagement-bar-container" id="engagement-bar">
                    <div class="engagement-bar-segment bar-engaged" id="bar-engaged" style="width: 0%;"><span></span></div>
                    <div class="engagement-bar-segment bar-not-engaged" id="bar-not-engaged" style="width: 0%;"><span></span></div>
                    <div class="engagement-bar-segment bar-disengaged" id="bar-disengaged" style="width: 0%;"><span></span></div>
                </div>
            </div>

            <div class="dashboard-card overall-score">
                <h3>OVERALL SCORE</h3>
                 <div class="grand-mean-container" id="grand-mean-display">
                    <span class="grand-mean-value" id="grand-mean-value">--</span>
                    <span class="grand-mean-label">GRANDMEAN</span>
                </div>
            </div>

            <!-- Middle Row -->
             <div class="dashboard-card category-pyramid">
                <h3>CATEGORY SCORES</h3>
                <div class="pyramid-container" id="category-pyramid-display">
                    <!-- Pyramid structure will be built by CSS/JS -->
                     <div class="pyramid-level growth">
                        <div class="pyramid-q-bubbles">
                            <span class="pyramid-q-bubble">Q11</span>
                            <span class="pyramid-q-bubble">Q12</span>
                        </div>
                        <span class="category-name">Growth</span>
                        <span class="category-score" id="score-growth">--</span>
                    </div>
                     <div class="pyramid-level teamwork">
                         <div class="pyramid-q-bubbles">
                            <span class="pyramid-q-bubble">Q7</span>
                            <span class="pyramid-q-bubble">Q8</span>
                            <span class="pyramid-q-bubble">Q9</span>
                            <span class="pyramid-q-bubble">Q10</span>
                        </div>
                        <span class="category-name">Teamwork</span>
                        <span class="category-score" id="score-teamwork">--</span>
                    </div>
                     <div class="pyramid-level individual">
                         <div class="pyramid-q-bubbles">
                            <span class="pyramid-q-bubble">Q3</span>
                            <span class="pyramid-q-bubble">Q4</span>
                            <span class="pyramid-q-bubble">Q5</span>
                            <span class="pyramid-q-bubble">Q6</span>
                        </div>
                        <span class="category-name">Individual</span>
                        <span class="category-score" id="score-individual">--</span>
                    </div>
                     <div class="pyramid-level basic-needs">
                         <div class="pyramid-q-bubbles">
                            <span class="pyramid-q-bubble">Q1</span>
                            <span class="pyramid-q-bubble">Q2</span>
                        </div>
                        <span class="category-name">Basic Needs</span>
                        <span class="category-score" id="score-basic-needs">--</span>
                    </div>
                </div>
            </div>

            <div class="dashboard-card question-list">
                 <h3>QUESTION LIST</h3>
                 <table class="results-table" id="results-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Question</th>
                            <th>Score (Resp.)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Rows will be populated by JavaScript -->
                        <tr><td colspan="3">Loading data...</td></tr>
                    </tbody>
                </table>
            </div>

             <!-- Bottom Row - Custom Questions -->
             <div class="dashboard-card custom-responses custom-q1">
                <h3>What we do well:</h3>
                <ul id="customQ1Responses" class="response-list">
                    <li>Loading...</li>
                </ul>
            </div>
            <div class="dashboard-card custom-responses custom-q2">
                <h3>What we could improve:</h3>
                <ul id="customQ2Responses" class="response-list">
                    <li>Loading...</li>
                </ul>
            </div>
        </main>

    </div><!-- End .dashboard-container -->

    <!-- JavaScript to fetch data and render dashboard -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const yearSelector = document.getElementById('yearSelector');
            let allData = []; // To store fetched data for all years

            // --- Helper function to update all dashboard components ---
            function updateDashboard(yearData) {
                if (!yearData) {
                    console.error("No data provided for the selected year.");
                    // Optionally clear the dashboard or show a message
                    clearDashboard();
                    return;
                }
                console.log(`Updating dashboard for year: ${yearData.year}`, yearData);

                // --- Populate Engagement Index Bar ---
                const dist = yearData.engagementIndex; // Use the new structure
                const engagedBar = document.getElementById('bar-engaged');
                const notEngagedBar = document.getElementById('bar-not-engaged');
                const disengagedBar = document.getElementById('bar-disengaged');

                if (engagedBar && notEngagedBar && disengagedBar && dist) {
                    // Use the direct keys from the new backend structure
                    engagedBar.style.width = `${dist.engaged}%`;
                    engagedBar.querySelector('span').textContent = `${dist.engaged}%`;
                    notEngagedBar.style.width = `${dist.notEngaged}%`;
                    notEngagedBar.querySelector('span').textContent = `${dist.notEngaged}%`;
                    disengagedBar.style.width = `${dist.activelyDisengaged}%`;
                    disengagedBar.querySelector('span').textContent = `${dist.activelyDisengaged}%`;

                    // Hide text if percentage is too small (e.g., < 5%)
                    [engagedBar, notEngagedBar, disengagedBar].forEach(bar => {
                        const span = bar.querySelector('span');
                        if (parseInt(bar.style.width) < 5) {
                            span.style.display = 'none';
                        } else {
                             span.style.display = 'inline';
                        }
                    });
                } else {
                     console.warn("Engagement bar elements or data not found.");
                     // Clear bars if data is missing
                     if (engagedBar) engagedBar.style.width = '0%';
                     if (notEngagedBar) notEngagedBar.style.width = '0%';
                     if (disengagedBar) disengagedBar.style.width = '0%';
                }


                // --- Populate Overall Score (Grand Mean) ---
                const grandMeanValue = document.getElementById('grand-mean-value');
                const grandMeanDisplay = document.getElementById('grand-mean-display');
                if (grandMeanValue && grandMeanDisplay) {
                    grandMeanValue.textContent = yearData.grandMean !== undefined ? yearData.grandMean.toFixed(2) : '--';
                    // Optional: Add color logic based on score
                    let meanColor = 'var(--ncoss-pop-yellow)'; // Default mid
                    if (yearData.grandMean >= 4.0) meanColor = 'var(--ncoss-bright-green)';
                    else if (yearData.grandMean < 3.0) meanColor = '#dc3545'; // Red
                    grandMeanDisplay.style.borderTopColor = meanColor; // Example styling
                } else {
                     console.warn("Grand mean elements not found.");
                }

                // --- Populate Category Pyramid ---
                const categoryScores = yearData.categoryScores;
                if (categoryScores) {
                    document.getElementById('score-basic-needs').textContent = categoryScores['basic-needs'] !== undefined ? categoryScores['basic-needs'].toFixed(2) : '--';
                    document.getElementById('score-individual').textContent = categoryScores['individual'] !== undefined ? categoryScores['individual'].toFixed(2) : '--';
                    document.getElementById('score-teamwork').textContent = categoryScores['teamwork'] !== undefined ? categoryScores['teamwork'].toFixed(2) : '--';
                    document.getElementById('score-growth').textContent = categoryScores['growth'] !== undefined ? categoryScores['growth'].toFixed(2) : '--';
                    // Add color logic to pyramid levels if desired (similar to grand mean)
                } else {
                     console.warn("Category score data not found.");
                     document.getElementById('score-basic-needs').textContent = '--';
                     document.getElementById('score-individual').textContent = '--';
                     document.getElementById('score-teamwork').textContent = '--';
                     document.getElementById('score-growth').textContent = '--';
                }


                // --- Populate Results Table ---
                const tableBody = document.querySelector('#results-table tbody');
                if (tableBody) {
                    tableBody.innerHTML = ''; // Clear previous rows

                    if (yearData.questions && yearData.questions.length > 0) {
                        yearData.questions.forEach(q => {
                            const row = tableBody.insertRow();

                            // Q ID Cell (with category dot)
                            const cellIdContainer = row.insertCell();
                            cellIdContainer.className = 'q-id-container';
                            // Create dot
                            const dot = document.createElement('span');
                            dot.className = `q-category-dot category-${q.category || 'unknown'}`; // Add category class
                            cellIdContainer.appendChild(dot);
                            // Create ID span
                            const idSpan = document.createElement('span');
                            idSpan.className = 'q-id';
                            idSpan.textContent = q.id; // Use integer ID
                            cellIdContainer.appendChild(idSpan);
                            // Question Text Cell
                            const cellText = row.insertCell();
                            cellText.className = 'q-text-container';
                            // Removed color bar logic

                            // Calculate score percentage (assuming max score is 5)
                            const scorePercent = q.score !== undefined ? (q.score / 5) * 100 : 0;
                            const categoryClass = `category-${q.category || 'unknown'}`;

                            // Restructure innerHTML for better layout control
                            cellText.innerHTML = `
                                <div class="question-cell-content">
                                    <span class="q-short-text">${q.question}</span>
                                    <span class="q-full-text">${q.description}</span>
                                    <div class="q-score-bar-container">
                                        <div class="q-score-bar ${categoryClass}" style="width: ${scorePercent}%;"></div>
                                    </div>
                                </div>
                            `;

                            // Score Cell
                            const cellScore = row.insertCell();
                            cellScore.className = 'q-score-col';
                            // Determine score class
                            let scoreClass = 'score-mid'; // Default
                            if (q.score >= 4.0) scoreClass = 'score-high';
                            else if (q.score < 3.0) scoreClass = 'score-low';

                            cellScore.innerHTML = `
                                <span class="q-score ${scoreClass}">${q.score !== undefined ? q.score.toFixed(2) : '--'}</span>
                                <span class="q-respondents">(${q.respondents !== undefined ? q.respondents : 0})</span>
                            `;
                        });
                    } else {
                        tableBody.innerHTML = '<tr><td colspan="3">No response data available for this year.</td></tr>';
                    }
                } else {
                     console.warn("Results table body not found.");
                }

                // --- Populate Custom Responses ---
                 function populateList(listId, responses) {
                    const listElement = document.getElementById(listId);
                    if (!listElement) return;
                    listElement.innerHTML = ''; // Clear loading/previous content
                    if (responses && responses.length > 0) {
                        responses.forEach(response => {
                            const li = document.createElement('li');
                            li.textContent = response;
                            listElement.appendChild(li);
                        });
                    } else {
                        const li = document.createElement('li');
                        li.textContent = "No responses submitted for this year.";
                        li.style.fontStyle = 'italic';
                        listElement.appendChild(li);
                    }
                }
                populateList('customQ1Responses', yearData.customQ1Responses);
                populateList('customQ2Responses', yearData.customQ2Responses);
            }

             // --- Function to clear dashboard display ---
             function clearDashboard() {
                 document.getElementById('bar-engaged').style.width = '0%';
                 document.getElementById('bar-not-engaged').style.width = '0%';
                 document.getElementById('bar-disengaged').style.width = '0%';
                 document.getElementById('grand-mean-value').textContent = '--';
                 document.getElementById('score-basic-needs').textContent = '--';
                 document.getElementById('score-individual').textContent = '--';
                 document.getElementById('score-teamwork').textContent = '--';
                 document.getElementById('score-growth').textContent = '--';
                 const tableBody = document.querySelector('#results-table tbody');
                 if (tableBody) tableBody.innerHTML = '<tr><td colspan="3">Select a year to view data.</td></tr>';
                 const q1List = document.getElementById('customQ1Responses');
                 if (q1List) q1List.innerHTML = '<li>Select a year.</li>';
                 const q2List = document.getElementById('customQ2Responses');
                 if (q2List) q2List.innerHTML = '<li>Select a year.</li>';
             }


            // --- Fetch data and initialize ---
            fetch('/dashboard/data')
                .then(response => {
                    if (!response.ok) {
                         // Check for specific error structure from backend
                         return response.json().then(errData => {
                             throw new Error(`HTTP error! status: ${response.status}, message: ${errData.error || 'Unknown server error'}`);
                         }).catch(() => {
                             // Fallback if response is not JSON
                             throw new Error(`HTTP error! status: ${response.status}`);
                         });
                    }
                    return response.json();
                })
                .then(fetchedData => {
                    // Check if backend returned an error object instead of list
                     if (fetchedData.error) {
                         throw new Error(`Server error: ${fetchedData.error}`);
                     }
                     // Expecting a list of yearly data objects
                     if (!Array.isArray(fetchedData)) {
                         throw new Error("Invalid data format received from server.");
                     }

                    allData = fetchedData; // Store all fetched data

                    // Populate year selector
                    yearSelector.innerHTML = ''; // Clear loading option
                    if (allData.length > 0) {
                        allData.forEach(data => {
                            const option = document.createElement('option');
                            option.value = data.year;
                            option.textContent = data.year;
                            yearSelector.appendChild(option);
                        });
                        // Select the first year (most recent) by default
                        yearSelector.value = allData[0].year;
                        updateDashboard(allData[0]); // Update dashboard with the first year's data
                    } else {
                        // Handle case with no data at all
                        yearSelector.innerHTML = '<option value="">No Data</option>';
                        clearDashboard(); // Clear display areas
                         const tableBody = document.querySelector('#results-table tbody');
                         if (tableBody) tableBody.innerHTML = '<tr><td colspan="3">No survey data found.</td></tr>';
                    }
                })
                .catch(error => {
                    console.error('Error fetching or processing dashboard data:', error);
                    // Display user-friendly error message
                    clearDashboard(); // Clear display areas
                    const tableBody = document.querySelector('#results-table tbody');
                     if (tableBody) {
                         tableBody.innerHTML = `<tr><td colspan="3" style="color: red;">Error loading dashboard data: ${error.message}. Please try again later.</td></tr>`;
                     }
                     yearSelector.innerHTML = '<option value="">Error</option>';
                });

            // --- Event listener for year selection change ---
            yearSelector.addEventListener('change', function() {
                const selectedYear = parseInt(this.value);
                const selectedYearData = allData.find(data => data.year === selectedYear);
                updateDashboard(selectedYearData);
            });
        });
    </script>

</body>
</html>
